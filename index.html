<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">

<title>pgday</title>

<meta name="description" content="Presentation about javascript & postgres">
<meta name="author" content="Nikolay Ryzhikov">

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

<link rel="stylesheet" href="css/reveal.css">
<link rel="stylesheet" href="css/theme/white.css" id="theme">

<!-- Code syntax highlighting -->
<link rel="stylesheet" href="lib/css/zenburn.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">

<!-- Printing and PDF exports -->
<script>
var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
</script>

<!--[if lt IE 9]><script src="lib/js/html5shiv.js"></script><![endif]-->
<style>
.reveal pre code {
  background: black;
  padding: 10px;
}
.reveal section img {
  border: none;
  box-shadow: none;
}
.slidernav img{
  width: 80px;
  display: inline-block;
  margin: 10px;
}
</style>
</head>

<body>

<div class="reveal">
  <div class="slides">
    <section>
      <h3>PostgreSQL</br>
        as app platform</h3>
      <h3></h3>
      <p>
      <small>Created by <a href="http://github.com/niquola">niquola</a> / <a href="http://twitter.com/niquola">@niquola</a></small>
      </p>
    </section>

    <section>
      <blockquote>
        PostgreSQL is Operation System
        <br/>
        for data
      </blockquote>
      <br/>
      <p><b>Simon Riggs</b></p>
    </section>

    <section>
      <h3>App Platform?</h3>
      <img src="platform.jpg" style="height: 500px"/>
    </section>

    <section>
      <h5> JavaScript inside PostgreSQL</h5>
      <img src="pg-and-js.jpg"/>
    </section>

    <section style="top: 0px; display: block;" class="present">
    <h5>
    Nikolay Ryzhikov
    </h5>
    <img src="niquola.jpg" style="border:none; height: 500px; box-shado: none; background: transparent;">
    <p>
      <a href="http://github.com/niquola">
      <i class="fa fa-github"></i>
      </a>
      <a href="http://twitter.com/niquola">
      <i class="fa fa-twitter"></i>
      </a>
      <a href="https://plus.google.com/u/0/+%D0%9D%D0%B8%D0%BA%D0%BE%D0%BB%D0%B0%D0%B9%D0%A0%D1%8B%D0%B6%D0%B8%D0%BA%D0%BE%D0%B2">
      <i class="fa fa-google-plus"></i>
      </a>
      <a href="https://www.facebook.com/nicola.ryzhikov">
      <i class="fa fa-facebook"></i>
      </a>
    </p>
    </section>

    <section style="top: 0px; display: block;" class="present">
      <h5>HealthSamurai</h5>
      <img src="hs.png" style="height: 200px;"/>
      <div class="slidernav">
      <img class="image _image image-3 js-fhirbase" src="choice.svg">
      <img class="image image-5 js-foodtaster" src="foodtaster.svg">
      <img class="image _image image-4 js-fotmstamp" src="stamp.svg">
      <img class="image _image image-2 js-choice-btn" src="fhirebase.svg">
      <img class="image image-5 js-foodtaster" src="aidbox-logo.png">
      </div>
    </section>

    <section>
      <img src="chs.png" style="float:right;"/>
      <h5 style="text-align:left;">MedClient EHR</h5>
      <img src="medclient.png"/>
    </section>

    <section>
      <h5>MedClient</h5>
      <ul>
        <li>Monolith + 10 services</li>
        <li>~0.5M ruby SLOC + jvm, js etc</li>
        <li>Auto install on AWS (chef/sensu/etc)</li>
        <li>5 databases ~ 1000 tables</li>
        <li>no heigh load (100 sessions)</li>
        <li>no big data (0.5T)</li>
        <li><b>structural complexity</b></li>
      </ul>
    </section>

    <section>
      <img src="onc.png"/>
      <img src="hl7.gif"/>
    </section>

    <section>
      <h3>Domain Complexity</h3>
      <img src="rim.png"/>
    </section>

    <section>
      <h3>We need standard!</h3>
      <h3>Which?</h3>
      <ul>
        <li>HL7 v2</li>
        <li>HL7 v3</li>
        <li>OpenEHR</li>
        <li><b>FHIR</b></li>
      </ul>
    </section>

    <section>
      <h3>MGrid</h3>
      <p>Database for HL7 v3 RIM (Postgres)</p>
      <img src="rim2.png"/>
    </section>

    <section>
      <h3>FHIR</h3>
      <img src="fhirf.png"/>
      <p>Fast Healthcare Interoperability Resources</p>
    </section>

    <section>
      <h3>FHIR: ~100 Resources</h3>
      <img src="res-map.png"/>
    </section>

    <section>
      <h3>FHIR: REST API</h3>
      <ul>
        <li>CRUD</li>
        <li>History</li>
        <li>Search</li>
        <li>Terminology</li>
        <li>...</li>
      </ul>
    </section>

    <section>
      <h3>Polyglot</h3>
      <img src="poliglot.jpg"/>
      <h5>Ruby, Clojure, JVM, JavaScript, .NET ...</h5>
    </section>

    <section>
      <img src="fhirbase.png"/>
      <h3><a href="http://fhirbase.github.io/demo/index.html#/">fhirbase</a></h3>
      <p>
      Relational Storage<br/>
      for FHIR resources
      </p>
    </section>

    <section>
      <h3>fhirbase</h3>
<pre><code class="sql">SELECT fhir.create($JSON$
 {
  resourceType: "Patient",
  name: [{text: "Ivan"}],
  birthDate: "1981-01-02"
 }
$JSON$);

SELECT fhir.search('Patient', 'name=ivan&birthdate=>1970');
</code></pre>
    </section>

    <section>
      <h3>works!?</h3>
      <hr/>
      <ul>
        <li>fhirface, Aidbox - clojure</li>
        <li>Netrika (SPb) - .NET</li>
        <li>Kainos (UK) - Java</li>
        <li>...</li>
      </ul>
    </section>

    <section>
      <h3>But, programmers UX is :(</h3>
      <img src="ux.jpg"/>
    </section>

    <section>
      <h3>UX & tooling</h3>
      <ul>
        <li>own preprocessor</li>
        <li>own modules</li>
        <li>own test framework</li>
        <li>own migrations</li>
      </ul>
    </section>

    <section>
      <h3>Preprocessor</h3>
      <pre><code class="sql">
func _build_url(_cfg_ jsonb, VARIADIC path text[]) RETURNS text
  SELECT _cfg_->>'base' || '/' || (SELECT string_agg(x, '/')
    FROM unnest(path) x)


CREATE OR REPLACE FUNCTION
module._build_url(_cfg_ jsonb, VARIADIC path text[]) RETURNS text
AS $$
  SELECT _cfg_->>'base' || '/' || (SELECT string_agg(x, '/')
    FROM unnest(path) x)
$$ language SQL immutable;
    </code></pre>
    </section>

    <section>
      <h3>Modules</h3>
      <pre><code class="sql">
-- #import ./fhirbase_json.sql
-- #import ./fhirbase_gen.sql
-- #import ./fhirbase_coll.sql
-- #import ./fhirbase_util.sql
-- #import ./fhirbase_generate.sql

func _build_url(_cfg_ jsonb, VARIADIC path text[]) RETURNS text
  SELECT _cfg_->>'base' || '/' || (SELECT string_agg(x, '/')
    FROM unnest(path) x)
      </code></pre>
    </section>

    <section>
      <h3>Tests</h3>
      <pre><code class="sql">
BEGIN;
_extract_id('rid/_history/vid') => 'rid'
-- SELECT expect(_extract_id('rid/_history/vid'),'rid')

SELECT fhirbase_generate.generate_tables('{Patient}');

setv('createOutcome',
  fhirbase_crud.create('{}'::jsonb, :'pt_json')
);

getv('createOutcome')->>'resourceType' => 'OperationOutcome'
getv('createOutcome')#>>'{issue,0,code,coding,1,code}' => '400'

ROLLBACK;
      </code></pre>
    </section>

    <section>
      <h3>threshold</h3>
      <img src="steps.jpg"/>
    </section>

    <section>
      <pre style="font-size: 9px; height: 100%;"><code class="sql">func _expand_search_params(_resource_type text, _query text) RETURNS setof query_param
  WITH RECURSIVE params(parent_resource, link_path, res, chain, key, operator, value) AS (
    SELECT null::text as parent_resource, -- we start with empty parent resoure
           '{}'::text[] as link_path, -- path of reference attribute to join
           _resource_type::text as res, -- this is resource to apply condition
           ARRAY[_resource_type]::text[] || key as chain, -- initial chain
           key as key,
           operator as operator,
           value as value
    FROM fhirbase_params._parse_param(_query)
    WHERE key[1] NOT IN ('_tag', '_security', '_profile', '_sort', '_count', '_page')
    UNION
    SELECT res as parent_resource, -- move res to parent_resource
           fhirbase_coll._rest(ri.path) as link_path, -- remove first element
           this.get_reference_type(x.key[1], re.ref_type) as res, -- set next res in chain
           x.chain AS chain, -- save search path
           fhirbase_coll._rest(x.key) AS key, -- remove first item from key untill only one key left
           x.operator,
           x.value
     FROM  params x
     JOIN  searchparameter ri
       ON  ri.name = split_part(key[1], ':',1)
      AND  ri.base = x.res
     JOIN  structuredefinition_elements re
       ON  re.path = ri.path
    WHERE array_length(key,1) > 1
  )
  SELECT
    parent_resource as parent_resource,
    link_path as link_path,
    res as resource_type,
    fhirbase_coll._butlast(p.chain) as chain,
    ri.search_type,
    ri.is_primitive,
    ri.type,
    fhirbase_coll._rest(ri.path)::text[] as field_path,
    fhirbase_coll._last(key) as key,
    operator,
    value
  FROM params p
  JOIN searchparameter ri
    ON ri.base = res
   AND ri.name = key[1]
 where array_length(key,1) = 1
  ORDER by p.chain
      </code></pre>
    </section>

    <section>
      <h3>Logic in DB</h3>
      <img src="bajan.jpg"/>
    </section>

    <section>
      <h3>Logic in DB (Smart Storage): PRO</h3>
      <hr/>
      <ul>
        <li>Performance (faster transactions, data locality)</li>
        <li>Consistency (like incapsulation)</li>
        <li>Integration by db</li>
        <li>Reuse</li>
      </ul>
    </section>

    <section>
      <h3>Logic in DB: CONTRA</h3>
      <hr/>
      <ul>
        <li>Overload database</li>
        <li>No good pracitces (TDD, modules etc)</li>
        <li>Archaic languages</li>
        <li>Slow development</li>
      </ul>
    </section>

    <section>
      <h3>Unresolvable?</h3>
      <hr/>
      <ul>
        <li>+modern language</li>
        <li>+modularity</li>
        <li>+tooling</li>
      </ul>
    </section>

    <section>
      <h3>Which lang?</h3>
    </section>

    <section>
      <img src="js.png"/>
      <br/>
      <ul>
        <li>everywhere (interop)</li>
        <li>everyone knows</li>
        <li>fast</li>
      </ul>
    </section>

    <section>
      <ul>
        <li><a href="http://www.youtube.com/watch?v=gz7KL7ZirZc">most misunderstood language</a>
        <li><a href="https://skillsmatter.com/skillscasts/2323-bobs-last-language">last programming language</a>
        <li><a href="http://githut.info/">githut</a></li>
        <li><a href="http://www.sitepoint.com/whats-best-programming-language-learn-2015/">2015</a></li>
      </ul>
    </section>

    <section>
      <h3>plv8: V8 JavaScript in pg </h3>
<ul>
  <li>Scalar function calls</li>
  <li>Trigger function calls</li>
  <li>Mapping between JS and DB types</li>
  <li>Prepared Statements and Cursors</li>
  <li>Subtransaction & Window function API</li>
  <li>Remote debugger</li>
  <li>Runtime separation across users</li>
</ul>
    </section>

    <section>
      <h3>plv8: functions</h3>
      <pre><code class="sql">
  CREATE FUNCTION plv8_test(keys text[], vals text[])
  RETURNS json AS $$
    var obj = {};
    for(var i=0; i&lt;keys.length; i++){
        obj[keys[i]] = vals[i];
    }
    return obj;
  $$ LANGUAGE plv8 IMMUTABLE STRICT;

  SELECT plv8_test(ARRAY['name', 'age'], ARRAY['Tom', '29']);
  --         plv8_test
  ---------------------------
  -- {"name":"Tom","age":"29"}
      </code></pre>
      <br/>
    </section>

    <section>
      <h3>plv8: returning function calls</h3>
      <pre><code class="sql">CREATE TYPE rec AS (i integer, t text);
CREATE FUNCTION set_of_records() RETURNS SETOF rec AS
$$
    // plv8.return_next() stores records in an internal tuplestore,
    // and return all of them at the end of function.
    plv8.return_next( { "i": 1, "t": "a" } );
    plv8.return_next( { "i": 2, "t": "b" } );

    // You can also return records with an array of JSON.
    return [ { "i": 3, "t": "c" }, { "i": 4, "t": "d" } ];
$$
LANGUAGE plv8;

SELECT * FROM set_of_records();
      </code></pre>
      <br/>
    </section>

    <section>
      <h3>plv8: triggers</h3>
      <pre><code class="sql">CREATE FUNCTION test_trigger() RETURNS trigger AS
$$
    plv8.elog(NOTICE, JSON.stringify(NEW));
    plv8.elog(NOTICE, JSON.stringify(OLD));
    plv8.elog(NOTICE, TG_OP);
    plv8.elog(NOTICE, TG_ARGV);
    if (TG_OP == UPDATE) {
        NEW.i = 102;
        return NEW;
    }
$$ LANGUAGE plv8;

CREATE TRIGGER test_trigger
BEFORE INSERT OR UPDATE OR DELETE
ON test_tbl FOR EACH ROW
EXECUTE PROCEDURE test_trigger('foo', 'bar');
      </code></pre>
      <br/>
    </section>


    <section>
      <h3>plv8: cursors</h3>
      <pre><code class="js">
  var plan = plv8.prepare(
   'SELECT * FROM tbl WHERE col = $1', ['int']
  );
  var rows = plan.execute( [1] );
  var sum = 0;
  for (var i = 0; i < rows.length; i++) {
    sum += rows[i].num;
  }
  plan.free();

  return sum;
      </code></pre>
      <br/>
    </section>

    <section>
      <h3>plv8: bench</h3>
      <hr/>
      <table>
        <tr>
          <th>alg</th>
          <th>sql</th>
          <th>v8</th>
          <th>pgsql</th>
        </tr>
        <tr>
          <td>noop</td>
          <td>1</td>
          <td>3.9</td>
          <td>5.0</td>
        </tr>
        <tr>
          <td>add</td>
          <td>1</td>
          <td>3.1</td>
          <td>4.8</td>
        </tr>
        <tr>
          <td>str</td>
          <td>~</td>
          <td>1</td>
          <td>1.8</td>
        </tr>
        <tr>
          <td>get key</td>
          <td>1</td>
          <td>4.4</td>
          <td>2.8</td>
        </tr>
        <tr>
          <td>iter</td>
          <td>~</td>
          <td>1</td>
          <td>1.2</td>
        </tr>
        <tr>
          <td>exec</td>
          <td>~</td>
          <td>1.2</td>
          <td>1</td>
        </tr>
        <tr>
          <td>polynom</td>
          <td>~</td>
          <td>1</td>
          <td>200</td>
        </tr>
      </table>

      <a href="https://github.com/niquola/pgday-spb-2015-slides/blob/master/plv8_bench/init.sql">improve</a>
    </section>

    <section>
      <h3>Not one language</h3>
      <ul>
        <li>CoffeeScript</li>
        <li>TypeScript</li>
        <li>ClojureScript</li>
        <li>PureScript</li>
        <li>pgsql :)</li>
        <li>your?</li>
      </ul>
    </section>

    <section>
      <h3>jsx -> jsql</h3>
<pre><code class="javascript">
var HelloMessage = React.createClass({
  render: function() {
    return <div>Hello {this.props.name}</div>;
  }
});
// why not
var x = 5;
(SELECT .* FROM users where id = x)
.map(function(u){
   return u.name;
})
</code></pre>

    </section>

    <section>
      <h3>We need more</h3>
      <hr/>
      <ul>
        <li>+ modularity</li>
        <li>+ tooling</li>
      </ul>
    </section>

    <section>
      <img src="node.png"/>
      <p>Event-driven I/O server-side <br/>
      JavaScript environment based on V8</p>
    </section>

    <section>
      <h3>PG + PLV8 + NODEJS?</h3>
      <hr/>
      <img src="happy.jpg"/>
    </section>

    <section>
      <h3>pg.js: concept</h3>
      <hr/>
      <ul>
         <li>write in node</li>
         <li>compile into plv8</li>
      </ul>
    </section>

    <section>
      <h3>pg.js: mock plv8</h3>
<pre><code class="coffee">Client = require('pg-native')
client = new Client
client.connectSync(conn_string)

global.INFO="INFO"
module.exports =
  execute: = ->
    client.querySync.apply(client, arguments).map(coerse)
  elog: (x, msg) ->
    console.log "#{x}:", msg
  quote_literal: (str)->
    str && client.pq.escapeLiteral(str)
  quote_ident: (str)->
    str && client.pq.escapeIdentifier(str)
</code></pre>

    </section>

    <section>
      <h3>pg.js: write in node</h3>
<pre><code class="coffee">util = require('./util')
uuid = (plv8)->
  plv8.execute('select gen_random_uuid() as uuid')[0].uuid

exports.uuid = uuid
create = (plv8, resource)->
  table_name = util.table_name(resource_type)
  # ...
  json  = JSON.stringify(resource)
  plv8.execute """
    INSERT INTO #{table_name}
    (id, version_id, content)
    VALUES ($1,$2,$3)
    """, [id, version_id, json]
  resource
</code></pre>
    </section>

    <section>
      <h3>pg.js: test in node</h3>
<pre><code class="coffee">
  plv8 = require('../lib/plv8')
  crud = require('../src/crud')
  schema = require('../src/schema')

  describe "CRUD", ()->
    beforeEach ()->
      schema.generate_table(plv8, 'Patient')

    it "read", ()->
      pt = {resourceType: 'Patient', name: {text: 'Albert'}}
      pt_created = crud.create(plv8, pt)
      expect(pt_created.id).toBeTruthy()
      expect(pt_created.meta.versionId).toBeTruthy()

</code></pre>
    </section>

    <section>
      <h3>pg.js: compile into plv8</h3>
<pre><code class="coffee">
  Module = require("module")
  oldrequire = Module::require
  Module::require = (fl) ->
    currentModule = fl
    oldrequire.apply this, arguments

  oldcompile = Module::_compile
  Module::_compile = (answer, filename) ->
    for k,v of @exports when v.plv8?
        plv8_exports[k] ={fn: v, filename: filename}

</code></pre>
<a href="https://github.com/niquola/pgpp/blob/master/lib/node2pl.coffee">github</a>
    </section>

    <section>
      <h3>pg.js: compile into plv8</h3>
<pre><code class="sql">
  CREATE OR REPLACE FUNCTION #{def_fn} AS $$
  var deps = {}
  var cache = {}
  #{modules_js}
  var require = function(dep){
    if(!cache[dep]) {
      var module = {exports: {}};
      deps[dep](module, module.exports, require);
      cache[dep] = module.exports;
    }
    return cache[dep]
  }
  return require('#{mod}').#{k}#{def_call};
  $$ LANGUAGE plv8 IMMUTABLE STRICT;
</code></pre>
    </section>

    <section>
      <h3>pg.js: call in postgres</h3>
<pre><code class="sql">
select fhir.read('StructureDefinition', 'Patient') as read
</code></pre>
    </section>

    <section>
      <h3>Experiments on github</h3>
      <ul>
        <li><a href="https://github.com/niquola/pgpp">pgpp</a></li>
        <li><a href="https://github.com/niquola/plpl">plpl</a></li>
        <li><a href="https://github.com/niquola/plpl-sample">plpl-sampl</a></li>
      </ul>
    </section>

    <section>
      <h3>pg.js: Road Map</h3>
      <hr/>
      <ul>
        <li>remove death code (Google closure comp)</li>
        <li>extend plv8 - require, native fn call,....</li>
        <li>deploy</li>
        <li>apply to fhirbase</li>
      </ul>
    </section>

    <section>
      <h3>Thx</h3>
      <hr/>
      <h2>Q?</h2>
    </section>
  </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

// Full list of configuration options available at:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
controls: true,
progress: true,
history: true,
center: true,

transition: 'slide', // none/fade/slide/convex/concave/zoom

// Optional reveal.js plugins
dependencies: [
{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
{ src: 'plugin/zoom-js/zoom.js', async: true },
{ src: 'plugin/notes/notes.js', async: true }
]
});

</script>

</body>
</html>
